---
title: "Estimating carbon stocks"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{estimating-stocks}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, echo=FALSE}
library(BlueCarbon)
library(tidyverse)
data(bc_data)

# TODO: Change this to use real data when compaction correction is changed
example_data <- bc_samples %>%
  filter(core_id == "core2",
         !is.na(oc)) %>%
  mutate(oc_concentration = oc)
```

# Estimating carbon stocks

> This vignette is an early draft

After you correct the compaction of your data, you can now calculate the carbon stock of your sediment cores. The final result will be the mass of carbon per unit of area. It's important to note that these stocks can be calculated to different sediment depths.

## Data requirements

By now your data should:  
1. Be corrected to account for decompression  
2. Contain an estimate of the carbon concentration in your samples (g C cm^3^)

# Estimation methods

To obtain the amount of carbon present per unit of area in the sediment core, you need to integrate the carbon concentration over depth, up to the maximum depth for which you want to calculate the stock. Basically, you want to calculate the area under the curve for your carbon concentration profiles.

There are several approaches to this, and this package includes 2:

1.  The rectangle method (Howard et al, 2014)

    This method assumes that the OC concentration of each core section is a constant value (as measured in your sample)

```{r}
bc_stocks(
  example_data,
  core_id = "core_id",
  sample_depth = "middle_depth",
  element_concentration = "oc_concentration",
  maximum_depth = 100,
  method = "rectangle",
  diagnostic_plot = TRUE
)
```

2.  The trapezoid method (Martins et al, 2021)

    This method assumes that the OC concentration changes linearly between collected samples

```{r}
bc_stocks(
  example_data,
  core_id = "core_id",
  sample_depth = "middle_depth",
  element_concentration = "oc_concentration",
  maximum_depth = 100,
  method = "trapezoid",
  diagnostic_plot = TRUE
)
```


## Which method to choose?

Which method to choose depends on how you decided to collect your samples. If you collected a single sample for each core section, the rectangle rule might be the most appropriate. If, however, you collected samples at regular intervals or at the start and end of core sections, the trapezoid method might be more appropriate. 

> TODO: Take some of the cores with samples every 2 cm, replicate both of these sampling methodologies and see which one is closer to the truth

# Data extrapolation

Calculated stocks are always dependent on the depth you chose. You can not compare a carbon stock for different sediment column heights. 

This can be an issue, as bibliography generally measures stocks for the top meter of sediment, but you can't always take cores this deep. Originally, some papers used a simple approximation by simply multiplying the stock by $\frac{100~cm}{measured~depth}$, which assumes that missing height of sediment has as much carbon as the sampled one. However, this is usually not true, as a carbon content decrease can be observed in the top meter of sediment. An approach that leads to smaller errors, while still imperfect, is propagating the last measured value to the required depth.

```{r}
example_data <- bc_samples %>%
  filter(core_id == "core1",
         !is.na(oc)) %>%
  mutate(oc_concentration = oc)

bc_stocks(
  example_data,
  core_id = "core_id",
  sample_depth = "middle_depth",
  element_concentration = "oc_concentration",
  maximum_depth = 100,
  method = "trapezoid",
  diagnostic_plot = TRUE
)

```

Please note that this method still assumes that the last recorded value is a good approximation of the carbon concentration in the rest of your sediment core. It's up to you to inspect the profile and see if that's true. 

> TODO: Add some plots comparing the method of multiplying the stock to propagating last recorded values - I already have a report about this, check the reports for Martins 2021

# References

Howard, Jennifer, Sarah Hoyt, Kirsten Isensee, Emily Pidgeon, and Maciej Telszewski, eds. 2014. Coastal Blue Carbon: Methods for Assessing Carbon Stocks and Emissions Factors in Mangroves, Tidal Salt Marshes, and Seagrass Meadows. Arlington, Virginia, USA: Conservation International, Intergovernmental Oceanographic Commission of UNESCO, International Union for Conservation of Nature. http://thebluecarboninitiative.org/manual/.

Martins, Márcio, Carmen B. de los Santos, Pere Masqué, A. Rita Carrasco, Cristina Veiga-Pires, and Rui Santos. 2021. “Carbon and Nitrogen Stocks and Burial Rates in Intertidal Vegetated Habitats of a Mesotidal Coastal Lagoon.” Ecosystems, June. https://doi.org/10.1007/s10021-021-00660-6.
